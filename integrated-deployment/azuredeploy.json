{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "branch": {
      "type": "string",
      "defaultValue": "main",
      "metadata": {
        "description": "Git branch to deploy from"
      }
    },
    "vmName": {
      "type": "string",
      "defaultValue": "OpenEMR-VM",
      "metadata": {
        "description": "Name of the OpenEMR Virtual Machine"
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "Admin username for the Virtual Machine"
      }
    },
    "authenticationType": {
      "type": "string",
      "defaultValue": "password",
      "allowedValues": ["sshPublicKey", "password"],
      "metadata": {
        "description": "Type of authentication"
      }
    },
    "adminPasswordOrKey": {
      "type": "securestring",
      "metadata": {
        "description": "SSH Key or password for the VM"
      }
    },
    "dnsLabelPrefix": {
      "type": "string",
      "defaultValue": "[toLower(concat('openemr-', uniqueString(resourceGroup().id)))]",
      "metadata": {
        "description": "DNS label for OpenEMR public IP"
      }
    },
    "workspaceName": {
      "type": "string",
      "defaultValue": "[concat('ahds-', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "AHDS workspace name"
      }
    },
    "fhirServiceName": {
      "type": "string",
      "defaultValue": "fhir",
      "metadata": {
        "description": "FHIR service name"
      }
    },
    "functionAppName": {
      "type": "string",
      "defaultValue": "[concat('fhir-conn-', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Function app name"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    }
  },
  "variables": {
    "workspaceName": "[parameters('workspaceName')]",
    "fhirServiceName": "[parameters('fhirServiceName')]",
    "fhirAudience": "[concat('https://', parameters('workspaceName'), '-', parameters('fhirServiceName'), '.fhir.azurehealthcareapis.com')]",
    "vmDeploymentUrl": "[concat('https://raw.githubusercontent.com/matthansen0/azure-openemr/', parameters('branch'), '/all-in-one/azuredeploy.json')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "openemrDeployment",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('vmDeploymentUrl')]"
        },
        "parameters": {
          "branch": {
            "value": "[parameters('branch')]"
          },
          "vmName": {
            "value": "[parameters('vmName')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "adminPasswordOrKey": {
            "value": "[parameters('adminPasswordOrKey')]"
          },
          "dnsLabelPrefix": {
            "value": "[parameters('dnsLabelPrefix')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.HealthcareApis/workspaces",
      "apiVersion": "2023-02-28",
      "name": "[variables('workspaceName')]",
      "location": "[parameters('location')]",
      "properties": {}
    },
    {
      "type": "Microsoft.HealthcareApis/workspaces/fhirservices",
      "apiVersion": "2023-02-28",
      "name": "[concat(variables('workspaceName'), '/', variables('fhirServiceName'))]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.HealthcareApis/workspaces', variables('workspaceName'))]"
      ],
      "kind": "fhir-R4",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "authenticationConfiguration": {
          "authority": "[concat('https://login.microsoftonline.com/', subscription().tenantId)]",
          "audience": "[variables('fhirAudience')]",
          "smartProxyEnabled": false
        }
      }
    }
  ],
  "outputs": {
    "openemrUrl": {
      "type": "string",
      "value": "[reference('openemrDeployment').outputs.openemrUrl.value]"
    },
    "fhirServiceUrl": {
      "type": "string",
      "value": "[variables('fhirAudience')]"
    },
    "deploymentInstructions": {
      "type": "string",
      "value": "Please run the post-deployment script to complete configuration"
    }
  }
}
